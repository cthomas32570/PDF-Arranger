<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>PDF Arranger</title>

    <link rel="canonical" href="https://getbootstrap.com/docs/5.1/examples/album/">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link href="style.css" rel="stylesheet">
</head>

<body>
    
    <header>
        <div class="collapse bg-dark" id="navbarHeader">
            <div class="container">
            <div class="row">
                <div class="col-sm-8 col-md-7 py-4">
                    <h4 class="text-white">About</h4>
                    <p class="text-muted">I made this website to show off some of the things I've learned in the past year. Thanks for stopping by!</p>
                </div>
                <div class="col-sm-4 offset-md-1 py-4">
                    <h4 class="text-white">Links</h4>
                    <ul class="list-unstyled">
                        <li><a href="http://shenanigans.digital/home.html" class="text-white">Home</a></li>
                        <li><a href="https://github.com/cthomas32570" class="text-white">GitHub</a></li>
                        <li><a href="#" class="text-white">Email me</a></li>
                    </ul>
                </div>
            </div>
            </div>
        </div>
        <div class="navbar navbar-dark bg-dark shadow-sm">
            <div class="container">
            <a href="#" class="navbar-brand d-flex align-items-center">
                <svg width="30" height="30" viewBox="0 0 1024 1024" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M531.3 574.4l.3-1.4c5.8-23.9 13.1-53.7 7.4-80.7-3.8-21.3-19.5-29.6-32.9-30.2-15.8-.7-29.9 8.3-33.4 21.4-6.6 24-.7 56.8 10.1 98.6-13.6 32.4-35.3 79.5-51.2 107.5-29.6 15.3-69.3 38.9-75.2 68.7-1.2 5.5.2 12.5 3.5 18.8 3.7 7 9.6 12.4 16.5 15 3 1.1 6.6 2 10.8 2 17.6 0 46.1-14.2 84.1-79.4 5.8-1.9 11.8-3.9 17.6-5.9 27.2-9.2 55.4-18.8 80.9-23.1 28.2 15.1 60.3 24.8 82.1 24.8 21.6 0 30.1-12.8 33.3-20.5 5.6-13.5 2.9-30.5-6.2-39.6-13.2-13-45.3-16.4-95.3-10.2-24.6-15-40.7-35.4-52.4-65.8zM421.6 726.3c-13.9 20.2-24.4 30.3-30.1 34.7 6.7-12.3 19.8-25.3 30.1-34.7zm87.6-235.5c5.2 8.9 4.5 35.8.5 49.4-4.9-19.9-5.6-48.1-2.7-51.4.8.1 1.5.7 2.2 2zm-1.6 120.5c10.7 18.5 24.2 34.4 39.1 46.2-21.6 4.9-41.3 13-58.9 20.2-4.2 1.7-8.3 3.4-12.3 5 13.3-24.1 24.4-51.4 32.1-71.4zm155.6 65.5c.1.2.2.5-.4.9h-.2l-.2.3c-.8.5-9 5.3-44.3-8.6 40.6-1.9 45 7.3 45.1 7.4zm191.4-388.2L639.4 73.4c-6-6-14.1-9.4-22.6-9.4H192c-17.7 0-32 14.3-32 32v832c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V311.3c0-8.5-3.4-16.7-9.4-22.7zM790.2 326H602V137.8L790.2 326zm1.8 562H232V136h302v216a42 42 0 0 0 42 42h216v494z"/>
                </svg>
                <strong>PDF Arranger</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarHeader" aria-controls="navbarHeader" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            </div>
        </div>
    </header>

    <main>



        <section class="py-5 text-center container">
            <div class="row py-lg-5">
            <div class="col-lg-6 col-md-8 mx-auto">
                <div class="row upload-drop-zone text-center mx-auto" id="drop-zone">
                    <p>Just drag and drop PDF files here</p>
                </div>
                <div class="row col-4 mx-auto text-center mergediv">
                    <button type="button" class="btn col btn-primary mergedoc">MERGE</button>
                    <button type="button" class="btn col btn-danger clearspace">CLEAR</button>
                </div>
            </div>
            </div>
        </section>

        <div class="album py-5 bg-light">
            <div class="container">

            <div class="row row-cols-5 workspace">



            </div>
            </div>
        </div>

    </main>

    <footer class="text-muted py-5">
        <div class="container">
            <p class="float-end mb-1">
            <a href="#">Back to top</a>
            </p>
            <p class="mb-1 text-center">&copy; Christopher Thomas</p>
        </div>
    </footer>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    
    <script type="text/javascript">

        $(document).ready(function() {
            $(".mergediv").hide();
        });


    ////////DRAG AND DROP FILE UPLOAD////////
        $(document).on("dragover", ".upload-drop-zone", function(event) {
            event.preventDefault();
            event.stopPropagation();
            $(this).addClass("drop");
        });

        $(document).on("dragleave", ".upload-drop-zone", function(event) {
            event.preventDefault();
            event.stopPropagation();
            $(this).removeClass("drop");
        });

        $(document).on("drop", ".upload-drop-zone", function(event) {
            event.preventDefault();
            event.stopPropagation();
            $(this).removeClass("drop");

            const formdata = new FormData();
            const formfiles = event.originalEvent.dataTransfer.files;
            
            let i = 0;
            for (const file of formfiles) {
                formdata.append("file" + i, file);
                i++;
            }

            const cfcPath = "PDFManager.cfc?method=splitPDF";

            $.ajax({
                url: cfcPath,
                data: formdata,
                type: 'POST',
                contentType: false,
                processData: false,
                success: function(res) {
                    
                    const html = $.parseHTML(res);

                    $(".mergediv").show();
                    $(".upload-drop-zone").hide();

                    $(".workspace").html(html);

                ////////ACTIVATE EVENT LISTENERS FOR NEWLY RENDERED HTML////////

                    // Drag and drop to switch div contents

                    $(".workspace").on("dragstart", ".page", function(ev) {
                        ev.originalEvent.dataTransfer.setData("drag_id", ev.target.id);
                    });

                    $(".workspace").on("dragover", ".page", function(ev) {
                        ev.preventDefault();
                    });

                    $(".workspace").on("drop", ".page", function(ev) {
                        ev.preventDefault();

                        const drag_id = ev.originalEvent.dataTransfer.getData("drag_id");
                        const drop_id = $(ev.target).closest(".page").attr("id");

                        const drag_html = $(`#${drag_id}`).html();
                        const drop_html = $(`#${drop_id}`).html();

                        $(`#${drag_id}`).html(drop_html);
                        $(`#${drop_id}`).html(drag_html);

                        $(`#${drag_id}`).attr("id", drop_id);
                        $(`#${drop_id}`).attr("id", drag_id);

                    });

                    //

                    $(".workspace").on("click", ".deletepage", function(ev) {
                        $(ev.target).closest(".card").remove();
                    });

                    $(".mergediv").on("click", ".mergedoc", mergeDoc);
                    $(".mergediv").on("click", ".clearspace", clearWorkspace);
                } 
            });        
        });

        // Returns comma delimited list of remaining pages in their arranged order. Used for merging the doc.
        function getPageList() {
            let pagelist = ""

            $(".page").each(function(index) {
                pagelist += $(this).attr("id") + ",";
            });

            console.log(pagelist);

            return pagelist.slice(0, -1);
        }

        function mergeDoc() {
            const formData = {pageList: getPageList()};

            $.post(
                "PDFManager.cfc?method=mergePDF",
                formData,
                function(res) {
                    window.open(`workspaces/${res}/document.pdf`);
                }
            );
        }

        function clearWorkspace() {
            
            $.post(
                "PDFManager.cfc?method=clearWorkspace",
                function() {
                    $(".mergediv").off();
                    $(".workspace").off();

                    $(".mergediv").hide();
                    $(".workspace").empty();
                    $(".upload-drop-zone").show();
                }
            )
        }

    </script>

      
</body>
</html>